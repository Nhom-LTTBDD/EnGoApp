// Firestore Security Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // USERS COLLECTION 
    // ============================================================================
    match /users/{userId} {
      // Cho ph√©p ƒë·ªçc n·∫øu ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p v√† ƒë√∫ng userId
      allow read: if request.auth != null && request.auth.uid == userId;

      // Cho ph√©p t·∫°o user m·ªõi khi ƒëƒÉng k√Ω (ph·∫£i tr√πng v·ªõi auth uid)
      allow create: if request.auth != null && request.auth.uid == userId;

      // Cho ph√©p c·∫≠p nh·∫≠t th√¥ng tin c·ªßa ch√≠nh m√¨nh
      allow update: if request.auth != null && request.auth.uid == userId;

      // Kh√¥ng cho ph√©p x√≥a user
      allow delete: if false;
    }
    
    // ============================================================================
    // PERSONAL VOCABULARIES COLLECTION (üÜï TH√äM M·ªöI)
    // ============================================================================
    match /personal_vocabularies/{userId} {
      // User ch·ªâ ƒë∆∞·ª£c ƒë·ªçc/ghi bookmarks c·ªßa ch√≠nh h·ªç
      allow read, write: if request.auth != null && request.auth.uid == userId;
        // Validate data structure khi t·∫°o m·ªõi
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasAll(['id', 'userId', 'vocabularyCardIds', 'createdAt', 'updatedAt'])
                    && request.resource.data.vocabularyCardIds is list;
      
      // Validate khi update
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.vocabularyCardIds is list;
    }
    
    // ============================================================================
    // USER STREAKS COLLECTION (üî• Streak tracking)
    // ============================================================================
    match /user_streaks/{userId} {
      // User ch·ªâ ƒë∆∞·ª£c ƒë·ªçc/ghi streak c·ªßa ch√≠nh h·ªç
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Validate data structure khi t·∫°o m·ªõi
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasAll(['userId', 'currentStreak', 'longestStreak', 'createdAt', 'updatedAt']);
      
      // Validate khi update
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.currentStreak is int
                    && request.resource.data.longestStreak is int;
    }
    
    // ============================================================================
    // DEFAULT DENY ALL (B·∫£o m·∫≠t)
    // ============================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
